{% extends "base.html" %} {% block head %}
<link rel="stylesheet" href="https://a439-official.github.io/css/text.css" />
<link rel="stylesheet" href="https://a439-official.github.io/css/form.css" />
<link rel="stylesheet" href="https://a439-official.github.io/css/text.css" />
<link rel="stylesheet" href="https://a439-official.github.io/css/card.css" />
<style>
    .modal-content {
        border-radius: 10px;
        background-color: rgba(0, 0, 0, 0.75);
        width: 80%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 30px;
        animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    /* 小说详情布局 */
    .book-details {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 20px;
    }

    .book-cover {
        width: 120px;
        height: 160px;
        border-radius: 8px;
        object-fit: cover;
    }

    .book-abstract {
        margin-top: 20px;
    }

    /* 搜索结果容器 */
    #search-results {
        margin-top: 20px;
        padding: 10px;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.05);
    }

    /* 加载指示器 */
    .loading-indicator,
    .no-more-indicator {
        text-align: center;
        padding: 20px;
        color: #999;
        font-style: italic;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .book-details {
            grid-template-columns: 1fr;
            text-align: center;
        }

        .book-cover {
            margin: 0 auto;
        }
        #search-results {
            max-height: 50vh;
        }
    }

    /* 搜索容器 */
    .search-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .search-container .form-input {
        flex: 1;
    }

    /* 小说卡片 */
    .book.card {
        cursor: pointer;
        transition: transform 0.2s;
    }

    .book.card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %} {% block content %}
<h1>搜索</h1>
<div class="search-container">
    <input type="text" id="search-input" class="form-input" placeholder="输入搜索关键词..." />
    <button id="search-btn" class="btn">搜索</button>
</div>
<div id="search-results" class="cards-container-grid">
    <p>输入关键词搜索小说</p>
</div>
{% endblock %} {% block modal %}
<!-- 小说详情模态框 -->
<h2>小说详情</h2>
<div id="modal-book-details"></div>
{% endblock %} {% block script %}
<script>
    // 应用状态
    const AppState = {
        search: {
            keyword: "",
            offset: 0,
            isLoading: false,
            hasMore: true,
        },
        elements: {
            searchInput: document.getElementById("search-input"),
            searchBtn: document.getElementById("search-btn"),
            searchResults: document.getElementById("search-results"),
        },
    };

    // 初始化应用
    function initApp() {
        // 设置事件监听器
        setupEventListeners();

        // 设置无限滚动
        setupInfiniteScroll();
    }

    // 设置事件监听器
    function setupEventListeners() {
        const { searchBtn, searchInput } = AppState.elements;

        // 模态框事件
        document.addEventListener("keydown", handleEscapeKey);

        // 搜索事件
        searchBtn.addEventListener("click", () => performSearch());
        searchInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") performSearch();
        });
    }

    // 加载小说列表
    async function loadBookList() {
        try {
            const data = await window.api.books();
            if (data.code === 200) {
                const bookListElement = document.getElementById("book-list");
                bookListElement.innerHTML = "";

                // 这里需要根据实际数据结构调整
                for (const search_tab of data.data.search_tabs) {
                    // 处理小说数据
                    console.log(search_tab);
                }
            }
        } catch (error) {
            console.error("加载小说列表失败:", error);
            document.getElementById("book-list").innerHTML = "<p>加载小说列表失败</p>";
        }
    }

    // 执行搜索
    async function performSearch(isLoadMore = false) {
        const { searchInput, searchResults } = AppState.elements;
        const keyword = searchInput.value.trim();

        if (!keyword) {
            searchResults.innerHTML = "<p>请输入搜索关键词</p>";
            return;
        }

        // 重置新搜索状态
        if (!isLoadMore) {
            AppState.search.keyword = keyword;
            AppState.search.offset = 0;
            AppState.search.hasMore = true;
            searchResults.innerHTML = "<p>搜索中...</p>";
        } else if (!AppState.search.hasMore || AppState.search.isLoading) {
            return;
        }

        // 显示加载指示器
        if (isLoadMore) {
            const loadingIndicator = document.createElement("div");
            loadingIndicator.className = "loading-indicator";
            loadingIndicator.innerHTML = "<p>加载更多...</p>";
            searchResults.appendChild(loadingIndicator);
        }

        AppState.search.isLoading = true;

        try {
            const data = await window.api.search({
                key: AppState.search.keyword,
                offset: AppState.search.offset,
            });

            if (data.code === 200) {
                processSearchResults(data, isLoadMore);
            } else {
                handleSearchError(isLoadMore);
            }
        } catch (error) {
            console.error("搜索失败:", error);
            handleSearchError(isLoadMore);
        } finally {
            AppState.search.isLoading = false;
        }
    }

    // 处理搜索结果
    function processSearchResults(data, isLoadMore) {
        const searchResults = AppState.elements.searchResults;

        // 移除加载指示器
        if (isLoadMore) {
            const loadingIndicator = searchResults.querySelector(".loading-indicator");
            if (loadingIndicator) loadingIndicator.remove();
        } else {
            searchResults.innerHTML = "";
        }

        let foundResults = false;

        for (const search_tab of data.data.search_tabs) {
            if (search_tab.tab_type === 3) {
                foundResults = true;
                const booksCount = search_tab.data.length;

                // 更新分页状态
                if (booksCount > 0) {
                    AppState.search.offset += booksCount;
                    AppState.search.hasMore = booksCount >= 10;
                } else {
                    AppState.search.hasMore = false;
                }

                // 显示小说
                search_tab.data.forEach((book) => {
                    const bookData = {
                        book_id: book.book_id,
                        book_name: book.book_data[0].book_name,
                        original_book_name: book.book_data[0].original_book_name,
                        raw_book_name: book.book_data[0].raw_book_name,
                        author: book.book_data[0].author,
                        abstract: book.book_data[0].abstract,
                        score: book.book_data[0].score,
                        word_number: book.book_data[0].word_number,
                        serial_count: book.book_data[0].serial_count,
                        category: book.book_data[0].category,
                        pure_category_tags: book.book_data[0].pure_category_tags,
                        thumb_url: book.book_data[0].thumb_url,
                        creation_status: book.book_data[0].creation_status,
                    };

                    searchResults.appendChild(createBookElement(bookData));
                });
            }
        }

        // 处理无结果情况
        if (!foundResults && !isLoadMore) {
            searchResults.innerHTML = "<p>未找到相关小说</p>";
        }

        // 显示无更多数据提示
        if (!AppState.search.hasMore && isLoadMore) {
            const noMoreIndicator = document.createElement("div");
            noMoreIndicator.className = "no-more-indicator";
            noMoreIndicator.innerHTML = "<p>没有更多数据了</p>";
            searchResults.appendChild(noMoreIndicator);
        }
    }

    // 处理搜索错误
    function handleSearchError(isLoadMore) {
        if (!isLoadMore) {
            AppState.elements.searchResults.innerHTML = "<p>搜索失败，请重试</p>";
        }
    }

    // 设置无限滚动
    function setupInfiniteScroll() {
        window.addEventListener("scroll", () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;

            if (scrollHeight - scrollTop - clientHeight < 100) {
                loadMoreResults();
            }
        });
    }

    // 加载更多结果
    function loadMoreResults() {
        if (AppState.search.keyword && AppState.search.hasMore && !AppState.search.isLoading) {
            performSearch(true);
        }
    }

    // 创建小说元素
    function createBookElement(bookData) {
        const bookElement = document.createElement("div");
        bookElement.id = `book-${bookData.book_id}`;
        bookElement.className = "book card";
        bookElement.addEventListener("click", () => showBookModal(bookData));

        bookElement.innerHTML = `
                <img src="${bookData.thumb_url}" alt="${bookData.book_name}">
                <h3>
                    <span>${bookData.book_name}</span>
                    <small>${bookData.score > 0 ? bookData.score : "暂无评分"}</small>
                </h3>
                <p>By ${bookData.author}</p>
            `;

        return bookElement;
    }

    // 显示小说详情模态框
    function showBookModal(bookData) {
        openModal();
        const modalDetails = document.getElementById("modal-book-details");

        modalDetails.innerHTML = `
                <div class="book-details">
                    <img src="${bookData.thumb_url}" alt="${bookData.book_name}" class="book-cover">
                    <div class="book-info-content">
                        <h3>${bookData.book_name}</h3>
                        <p><strong>作者：</strong>${bookData.author}</p>
                        <p><strong>评分：</strong>${bookData.score > 0 ? bookData.score : "暂无评分"}</p>
                        <p><strong>分类：</strong>${bookData.category}</p>
                        <p><strong>标签：</strong>${bookData.pure_category_tags}</p>
                        <p><strong>字数：</strong>${bookData.word_number}</p>
                        <p><strong>章节数：</strong>${bookData.serial_count}</p>
                        <p><strong>更新状态：</strong>${bookData.creation_status}</p>
                    </div>
                </div>
                <button id="modal-download-btn" class="btn" data-book-id="${bookData.book_id}" style="margin-top: 10px;">下载小说</button>
                <div class="book-abstract">
                    <h4>内容简介</h4>
                    <div class="abstract-text">${bookData.abstract || "暂无简介"}</div>
                </div>
            `;

        // 添加下载按钮事件
        const downloadBtn = document.getElementById("modal-download-btn");
        downloadBtn.addEventListener("click", async () => {
            const bookId = downloadBtn.dataset.bookId;
            downloadBtn.disabled = true;
            downloadBtn.textContent = "下载中...";

            try {
                const result = await window.download.downloadBook(bookId);
                if (result.success) {
                    downloadBtn.textContent = "已开始下载";
                    setTimeout(() => {
                        closeModal();
                    }, 1500);
                } else {
                    downloadBtn.textContent = "下载失败";
                    setTimeout(() => {
                        downloadBtn.textContent = "下载小说";
                        downloadBtn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                downloadBtn.textContent = "下载出错";
                setTimeout(() => {
                    downloadBtn.textContent = "下载小说";
                    downloadBtn.disabled = false;
                }, 2000);
            }
        });

        document.body.style.overflow = "hidden";
    }

    // 初始化应用
    document.addEventListener("DOMContentLoaded", initApp);
</script>
{% endblock %}
